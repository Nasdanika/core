Nasdanika Drawio module provides [Java API](https://docs.nasdanika.org/modules/core/apidocs/org.nasdanika.drawio/module-summary.html) for reading and manipulating [Drawio](https://www.diagrams.net/) diagrams.
It is built on top of [Graph](../graph/index.html).

To use the module add the below dependency to your ``pom.xml``:

```xml
<dependency>
	<groupId>org.nasdanika.core</groupId>
	<artifactId>drawio</artifactId>
	<version>...</version>
</dependency>
```

See https://mvnrepository.com/artifact/org.nasdanika.core/drawio for the latest version.

The module requires Java 11 or above.

[TOC levels=6]

## Overview

The module provides the following interfaces representing elements of a diagram file:

* ${javadoc/org.nasdanika.drawio.Document} - the root object of the API representing a file/resource which contains one or more pages.
* ${javadoc/org.nasdanika.drawio.Page} - a page containing a diagram (Model).
* ${javadoc/org.nasdanika.drawio.Model} - a diagram model containing diagram root.
* ${javadoc/org.nasdanika.drawio.Root} - the root of the model containing layers.
* ${javadoc/org.nasdanika.drawio.Layer} - a diagram may have one or more layers. Layers contain Nodes and Connections.
* ${javadoc/org.nasdanika.drawio.Node} - a node can be connected to other nodes with connections. A node may contain other nodes and connections.
* ${javadoc/org.nasdanika.drawio.Connection} - a connection between two nodes. 

The below diagram shows relationships between the above interfaces including their super-interfaces:

```drawio-resource
./classes.drawio
```

${javadoc/org.nasdanika.drawio.Util} provides utility methods such as ``layout()`` and methods to navigate and query documents and their elements.

## Examples

* [Actions](https://docs.nasdanika.org/demo-drawio-actions/) - Demo of generation of a web site from a drawio diagram
* [Flow](https://docs.nasdanika.org/demo-drawio-flow-actions) - Demo of generation of a web site from a flow drawio diagram
* [Mind map](https://docs.nasdanika.org/demo-drawio-map) - Demo of generation of a web site from a (mind) map drawio diagram

## Creating a new document

To create a new document use ``Document.create()``:

```java
Document document = Document.create(false, null);
Page page = document.createPage();
page.setName("My first new page");
		
Model model = page.getModel();
Root root = model.getRoot();
List<Layer> layers = root.getLayers();
		
// Add layer
Layer newLayer = root.createLayer();
newLayer.setLabel("My new layer");
				
// Add nodes
Node source = newLayer.createNode();
source.setLabel("My source node");
Rectangle sourceGeometry = source.getGeometry();
sourceGeometry.setX(200);
sourceGeometry.setX(100);
sourceGeometry.setWidth(70);
sourceGeometry.setHeight(30);
source.getTags().add("aws");
				
Node target = newLayer.createNode();
target.setLabel("My target node");
target.getGeometry().setBounds(300, 150, 100, 30);
Set<String> targetTags = target.getTags();
targetTags.add("aws");
targetTags.add("azure");
		
// Add connection 
Connection connection = newLayer.createConnection(source, target);
connection.setLabel("My connection");
Map<String, String> connectionStyle = connection.getStyle();
connectionStyle.put("edgeStyle", "orthogonalEdgeStyle");
connectionStyle.put("rounded", "1");
connectionStyle.put("orthogonalLoop", "1");
connectionStyle.put("jettySize", "auto");
connectionStyle.put("html", "1");
				
Files.writeString(new File("new-uncompressed.drawio").toPath(), document.save(null));
```

## Loading

To load use one of ``load()`` methods. The below snippet loads from a class loader resource.

```java
Document document = Document.load(getClass().getResource("compressed.drawio"));
```

It is also possible to load a document from PNG metadata - this can be used with PNG files generated by Drawio editors with "Include copy of my diagram" checked.

```java
List<Document> documents = Document.loadFromPngMetadata(getClass().getResource("illustration.png"));
```

## Saving

Document content can be retrieved as a String using ``save()`` method:

```java
Files.writeString(new File("compressed.drawio").toPath(), document.save(null));
```

To embed a diagram into HTML use ``toHtml()`` method:

```java
Files.writeString(new File("compressed.html").toPath(), document.toHtml(null, "https://cdn.jsdelivr.net/gh/Nasdanika/drawio@dev/src/main/webapp/js/viewer-static.min.js"));
```

## Layout

The API provide a simple layout algorithm which arranges nodes so that they don't overlap. 
It can be used with generated diagrams to make them easier to layout manually after generation.

```java
org.nasdanika.drawio.Util.layout(root, 20);
```

## Page linking

The API extends the page linking concept of Drawio to link an element in one document to a page in another document.
This allows to create a tree/network of linked diagrams. For example, a complex system or process may be modeled in multiple diagrams 
maintained by multiple teams.

To link a page in another document (file):

* To link to the first page in the document set link to ``data:page,<URL>``, where ``<URL>`` is resolved relative to the URL of the current document. Example: ``data:page,compressed.drawio``.
* To link to a specific page set link to ``data:page/name,<URL>#<URL encoded page name>``. Example: ``data:page/name,compressed.drawio#Page+2``

## Traversing

To traverse document elements you can use either ``accept(<visitor>)`` methods or ``stream()`` method.

## EMF

### DrawioResource

${javadoc/org.nasdanika.drawio.emf.DrawioResource} is a base class for mapping of diagram elements to [EMF](https://www.eclipse.org/modeling/emf/) Ecore model elements. 
With DrawioResource Drawio files are treated as model resources which can be loaded into a resource set and as such reference model elements in other resources and be referenced from other resources.
${javadoc/org.nasdanika.html.model.app.drawio.ResourceFactory} is a concrete implementation for mapping diagram elements to  [application model](https://docs.nasdanika.org/modules/html/modules/models/modules/app/modules/model/index.html) [actions](https://docs.nasdanika.org/modules/html/modules/models/modules/app/modules/model/Action.html).

### DrawioEObjectFactory

${javadoc/org.nasdanika.drawio.emf.DrawioEObjectFactory} is a specialization of ${javadoc/org.nasdanika.graph.processor.emf.AbstractEObjectFactory} for Drawio diagrams.
It loads semantic information from properties of diagram elements as explained below.
``DrawioEObjectFactory`` is abstract. It does not dictate semantic specification format - subclasses shall implement ``T load(String spec, URI specBase, ProcessorConfig<T> config, ProgressMonitor progressMonitor)`` method.

#### Conifguration properties

##### child-injectors

The value of this property shall be a [Spring expression](https://docs.spring.io/spring-framework/docs/5.3.24/reference/html/core.html#expressions)
which injects children into the semantic element. 
Expression value is not used.
To inject multiple children you may use [linine list](https://docs.spring.io/spring-framework/docs/5.3.24/reference/html/core.html#expressions-inline-lists) expression ``{ <expr>[, <expr>] }``

The expression is evaluated in the context of the semantic element with the following variables:

* ``children`` - a map of children with child diagram elements as keys and their ${javadoc/org.nasdanika.graph.processor.ProcessorInfo}s as values
* ``config`` - semantic element config of type ${javadoc/org.nasdanika.graph.processor.ProcessorConfig}
* ``element`` - diagram element
  
##### child-reference

Reference name of the semantic parent to inject this semantic element into.

##### child-references

A YAML map of reference names to selectors - Spring boolean expressions. 
Children matching the selector expression are injected into the respective reference of the semantic element.
Expressions are evaluated in the context of a child semantic element to be matched with the following variables:

* ``config`` - context (child) semantic element ProcessorConfig.
* ``element`` - child diagram element.
* ``parent`` - semantic element. 
* ``parentConfig`` - semantic element ProcessorConfig.
* ``parentElement`` - diagram element.

##### incoming-injector

Connection property - a spring expression to inject this connection's semantic element (or source semantic element for pass-through connections) into its target's semantic element. 
Evaluated in the context of the target semantic element with the following variables:

* ``element`` - diagram element
* ``config`` - processor config
* ``connection`` - incoming connection
* ``incoming`` - incoming semantic element
* ``incomingConfig`` - incoming processor config

##### incoming-reference

Connection property specifying reference name of the connection's target semantic element to inject this connection semantic element or connection's source semantic element if the connection doesn't have its own semantic element (pass-through connection).

##### link-page                

By default semantic elements from linked pages are wired in the same way as element children.
To disable wiring of linked page elements set this property to ``false``.

##### outgoing-injector

Connection property - a spring expression to inject this connection's semantic element (or target semantic element for pass-through connections) into its source's semantic element. 
Evaluated in the context of the source semantic element with the following variables:


* ``element`` - diagram element
* ``config`` - processor config
* ``connection`` - incoming connection
* ``outgoing`` - outgoing semantic element
* ``outgoingConfig`` - outgoing processor config

##### outgoing-reference

Connection property specifying reference name of the connection's source semantic element to inject this connection semantic element or connection's target semantic element if the connection doesn't have its own semantic element (pass-through connection).

##### parent-injector

Spring expression to inject parent into this semantic element. 
Evaluated in the context of the semantic element with the following variables:

* ``config`` - this semantic element processor config
* ``element`` -  this diagram element
* ``parent`` - parent semantic element
* ``parentConfig`` - parent processor config
  
##### parent-reference

Reference name of this semantic element to inject the parent semantic element into.

##### registry-injectors

Spring expression to inject registry entries into this semantic element. 
Evaluated expression value is not used.
The expression is evaluated in the context of the semantic element with the following variables:

* ``config`` - this semantic element processor config
* ``element`` - this diagram element
* ``registry`` - a map of diagram elements to their registry info's

##### registry-references

A YAML map of reference names to selectors - Spring boolean expressions. 
Registry entries matching the selector expression are injected into the respective reference of the semantic element.
Expressions are evaluated in the context of a registry semantic element to be matched with the following variables:

* ``config`` - context (child) semantic element ProcessorConfig.
* ``element`` - child diagram element.
* ``registryElement`` - registry diagram element. 
* ``registryConfig`` - processor config of the registry element. 
* ``semanticElement`` - semantic element. 
  
##### semantic-uri

URI of the semantic element definition. 

The difference between ``semantic-uri`` and ``spec-uri`` is that the spec is loaded as a string, interpolated, and then used to load the semantic element. ``spec-uri`` supports YAML and JSON definitions, whereas ``semantic-uri`` can point to definitions in multiple formats - XMI, Drawio, YAML, Json, MS Excel, ...

##### source-injector

Connection property - a spring expression to inject this connection source semantic element into this connection semantic element. 
Evaluated in the context of the connection semantic element with the following variables:

* ``element`` - diagram element (connection)
* ``config`` - processor config
* ``source`` - source semantic element
* ``sourceConfig`` - source processor config

##### source-reference

Name of a reference to inject this connection source semantic element into this connection semantic element.

##### spec

Specification of the semantic element. YAML or JSON.

Example:

```yaml
ncore-temporal: 
  offset: ${diagram-element/expr/outgoingConnections[0].label}
  description: ${diagram-element/label}
```

##### ResourceSetDrawioEObjectFactory

${javadoc/org.nasdanika.drawio.emf.ResourceSetDrawioEObjectFactory} is a specialization of ${javadoc/org.nasdanika.drawio.emf.DrawioEObjectFactory}.
It is used by ${javadoc/org.nasdanika.drawio.emf.ResourceSetDrawioResource} and ${javadoc/org.nasdanika.drawio.emf.ResourceSetDrawioResourceFactory}.

In ``ResourceSetDrawioEObjectFactory`` specification is interpolated with the following tokens:

* ``diagram-element/expression`` - spring expression evaluated in the context of the diagram element with the following variables:
    * ``context`` - ${javadoc/org.nasdanika.common.Context} providing access to additional information.
    * ``config`` - processor config
* ``diagram-element/id`` - element id for pages and model element
* ``diagram-element/label`` - model element label
* ``diagram-element/label-text`` - model element label plain text. Label is parsed as HTML and then converted to text.
* ``diagram-element/link`` - model element link
* ``diagram-element/name`` - page name
* ``diagram-element/properties/<property name>`` - model element property value
* ``diagram-element/tooltip`` - model element tooltip

Additional tokens may be provided by sub-classing ``ResourceSetDrawioEObjectFactory`` or ``ResourceSetDrawioResourceFactory`` and overriding ``getContext()`` method.

##### spec-format

Specification format - ``yaml`` or ``json``. The format is inferred if not explicitly specified - 
specifications starting with ``{`` and ending with ``}`` are assumed to be JSON, YAML otherwise.

##### spec-uri

URI of the specification resolved relative to the document URI.
Specification is loaded from the specification URI, interpolated, and then a semantic element is loaded from it.

##### target-reference

Name of a reference to inject this connection target semantic element into this connection semantic element.

##### target-injector

Connection property - a spring expression to inject this connection target semantic element into this connection semantic element. 
Evaluated in the context of the connection semantic element with the following variables:

* ``element`` - diagram element (connection)
* ``config`` - processor config
* ``target`` - target semantic element
* ``targetConfig`` - target processor config

## Sorting

${javadoc/org.nasdanika.drawio.comparators} package contains comparators for sorting diagram elements based on their label, properties, and geometry.

## Executable diagrams

[Graph](../graph/index.html) documentation explains how to implement graph processors which can be used to make diagrams executable.

## Applications

This section lists some possible applications of Drawio Java API and semantic mappings:

* High Level Design -> Low Level Design -> Implementation. Define High Level Design in diagrams. Then generate a web site with documentation for Low Level Design. Then use semantic mapping or executable diagrams approach to either generate code from diagrams or execute diagrams directly.
* Documentation/books/video courses - create a mind map, generate a site from it, add documentation to diagram elements.
* Reporting - create a diagram of your system/business/effort, generate a documentation site. Enrich diagrams with status - implementation status for systems being built pulled from issue tracker(s), system health status pulled from monitoring systems.
