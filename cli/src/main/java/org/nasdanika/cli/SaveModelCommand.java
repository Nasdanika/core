package org.nasdanika.cli;

import java.io.File;

import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.ResourceSet;
import org.nasdanika.common.EObjectSupplier;
import org.nasdanika.common.ProgressMonitor;

import picocli.CommandLine.Command;
import picocli.CommandLine.Mixin;
import picocli.CommandLine.Parameters;
import picocli.CommandLine.ParentCommand;

@Command(
		description = "Saves model to a file",
		versionProvider = ModuleVersionProvider.class,		
		mixinStandardHelpOptions = true,
		name = "save")
@ParentCommands(EObjectSupplier.class)
@Description(icon = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHg9IjBweCIgeT0iMHB4IiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCI+CjxwYXRoIGZpbGw9IiNjMmNkZTciIGQ9Ik01NSw1N0g5YTIsMiwwLDAsMS0yLTJWOUEyLDIsMCwwLDEsOSw3SDQ3YTIsMiwwLDAsMSwxLjQxLjU5bDgsOEEyLDIsMCwwLDEsNTcsMTdWNTVBMiwyLDAsMCwxLDU1LDU3WiI+PC9wYXRoPjxyZWN0IHdpZHRoPSIzNCIgaGVpZ2h0PSIyNiIgeD0iMTUiIHk9IjMxIiBmaWxsPSIjZmFlZmRlIiByeD0iMiIgcnk9IjIiPjwvcmVjdD48cmVjdCB3aWR0aD0iMzAiIGhlaWdodD0iMTgiIHg9IjE1IiB5PSI3IiBmaWxsPSIjYmJkZWY5IiByeD0iMiIgcnk9IjIiIHRyYW5zZm9ybT0icm90YXRlKDE4MCAzMCAxNikiPjwvcmVjdD48cGF0aCBmaWxsPSIjZGVmMGZmIiBkPSJNNDUgN0wzNy4wOCA3IDIyLjgzIDI1IDM1LjY3IDI1IDQ1IDEzLjIxIDQ1IDd6TTE1IDE4Ljg5TDI0LjQyIDcgMjMuMjUgNyAxNSAxNy40MiAxNSAxOC44OXpNMjcuOTIgN0wxNSAyMy4zMiAxNSAyNSAxOS4xNyAyNSAzMy40MiA3IDI3LjkyIDd6Ij48L3BhdGg+PHJlY3Qgd2lkdGg9IjQiIGhlaWdodD0iMTAiIHg9IjM3IiB5PSIxMSIgZmlsbD0iI2ZmZWI5YiIgcng9IjIiIHJ5PSIyIj48L3JlY3Q+PHBhdGggZmlsbD0iI2VmZDhiZSIgZD0iTTE5LDUwSDQ1YTQsNCwwLDAsMSw0LDR2M2EwLDAsMCwwLDEsMCwwSDE1YTAsMCwwLDAsMSwwLDBWNTRBNCw0LDAsMCwxLDE5LDUwWiI+PC9wYXRoPjxwYXRoIGZpbGw9IiM4ZDZjOWYiIGQ9Ik01Ni41NCwxNC4xMiw0OS44OCw3LjQ2QTUsNSwwLDAsMCw0Ni4zNCw2SDlBMywzLDAsMCwwLDYsOVY1NWEzLDMsMCwwLDAsMywzSDU1YTMsMywwLDAsMCwzLTNWMTcuNjZBNSw1LDAsMCwwLDU2LjU0LDE0LjEyWk00NCw4VjIzYTEsMSwwLDAsMS0xLDFIMTdhMSwxLDAsMCwxLTEtMVY4Wk0xNiw1NlYzM2ExLDEsMCwwLDEsMS0xSDQ3YTEsMSwwLDAsMSwxLDFWNTZabTQwLTFhMSwxLDAsMCwxLTEsMUg1MFYzM2EzLDMsMCwwLDAtMy0zSDE3YTMsMywwLDAsMC0zLDNWNTZIOWExLDEsMCwwLDEtMS0xVjlBMSwxLDAsMCwxLDksOGg1VjIzYTMsMywwLDAsMCwzLDNINDNhMywzLDAsMCwwLDMtM1Y4aC4zNGEzLDMsMCwwLDEsMi4xMi44OGw2LjY2LDYuNjZBMywzLDAsMCwxLDU2LDE3LjY2WiI+PC9wYXRoPjxwYXRoIGZpbGw9IiNlYjk2OTciIGQ9Ik0zOSAzOGg0YTEgMSAwIDAgMCAwLTJIMzlhMSAxIDAgMCAwIDAgMnpNMjEgMzhIMzVhMSAxIDAgMCAwIDAtMkgyMWExIDEgMCAwIDAgMCAyek0zOSA0MEgyMWExIDEgMCAwIDAgMCAySDM5YTEgMSAwIDAgMCAwLTJ6Ij48L3BhdGg+PHBhdGggZmlsbD0iIzhkNmM5ZiIgZD0iTTE5IDQ4YTEgMSAwIDAgMC0xIDF2MmExIDEgMCAwIDAgMiAwVjQ5QTEgMSAwIDAgMCAxOSA0OHpNMjQgNDhhMSAxIDAgMCAwLTEgMXYyYTEgMSAwIDAgMCAyIDBWNDlBMSAxIDAgMCAwIDI0IDQ4ek0yOSA0OGExIDEgMCAwIDAtMSAxdjJhMSAxIDAgMCAwIDIgMFY0OUExIDEgMCAwIDAgMjkgNDh6TTM0IDQ4YTEgMSAwIDAgMC0xIDF2MmExIDEgMCAwIDAgMiAwVjQ5QTEgMSAwIDAgMCAzNCA0OHpNMzkgNDhhMSAxIDAgMCAwLTEgMXYyYTEgMSAwIDAgMCAyIDBWNDlBMSAxIDAgMCAwIDM5IDQ4ek00NCA0OGExIDEgMCAwIDAtMSAxdjJhMSAxIDAgMCAwIDIgMFY0OUExIDEgMCAwIDAgNDQgNDh6TTM5IDIyYTMgMyAwIDAgMCAzLTNWMTNhMyAzIDAgMCAwLTYgMHY2QTMgMyAwIDAgMCAzOSAyMnptLTEtOWExIDEgMCAwIDEgMiAwdjZhMSAxIDAgMCAxLTIgMHoiPjwvcGF0aD4KPC9zdmc+")
public class SaveModelCommand extends CommandBase {
	
	@Parameters(
		index =  "0",	
		arity = "1",
		description = "Output file")
	private File output;

	@ParentCommand
	EObjectSupplier<EObject> eObjectSupplier;
	
	@Mixin
	ProgressMonitorMixIn progressMonitorMixIn;
	
	@Mixin
	ResourceSetMixIn resourceSetMixIn;

	@Override
	public Integer call() throws Exception {
		ProgressMonitor progressMonitor = progressMonitorMixIn.createProgressMonitor(1);
		ResourceSet resourceSet = resourceSetMixIn.createResourceSet(progressMonitor.split("Creating a resource set", 1));
		URI resourceURI = URI.createFileURI(output.getAbsolutePath());		
		Resource resource = resourceSet.createResource(resourceURI);
		resource.getContents().addAll(eObjectSupplier.getEObjects(progressMonitor.split("Generating contents", 1)));
		resource.save(null);		
		return 0;
	}	

}
